/**
 * @codekit-append "app/hubJS.js"
 * @codekit-append "app/hubWidget.js"
 */


/* **********************************************
     Begin hubJS.js
********************************************** */

var hubJS = (function (global, $) {

	/**
	 * Hub library object for reference inside
	 * return object.
	 */
	var _library;

	/**
	 * Default settings
	 * @type {Object}
	 */
	var _defaultSettings = {
		version: 0
	};


	return {

		/**
		 * User defined settings
		 * @type {Object}
		 */
		userSettings: {},

		/**
		 * API base URL
		 * @type {String}
		 */
		baseUrl: "http://api.hub.jhu.edu/",

		/**
		 * Initialize the Hub library.
		 * 
		 * @param  {object} settings
		 * @return null
		 */
		init: function (settings) {
			_library = this;
			_library.userSettings = $.extend({}, _defaultSettings, settings);
		},

		/**
		 * Gets a payload from the Hub API
		 * 
		 * @param  {string} 	endpoint  	API endpoint
		 * @param  {object} 	data     	Data to be sent to the server
		 * @param  {function} 	callback 	Function to run when request is successful
		 * @return {jqXHR}    				See: http://api.jquery.com/jQuery.ajax/#jqXHR
		 */
		get: function(endpoint, data, callback) {

			var data = $.extend({}, data);
			data.v = _library.userSettings.version;

			if (data.id) {
				endpoint = endpoint + "/" + data.id;
				delete data.id;
			}

	        return $.ajax({
	            url: _library.baseUrl + endpoint,
	            dataType: "jsonP",
	            data: data,
	            success: callback,
	            fail: _library.userSettings.fail
	        });
	    },

	    /**
	     * Articles methods
	     * @type {Object}
	     */
		articles: {

			/**
			 * Find an article or articles
			 * 
			 * @param  {object} 	data     	Data to be sent to the server
			 * @param  {function} 	callback 	Function to run when request is successful
			 * @return {jqXHR}    				See: http://api.jquery.com/jQuery.ajax/#jqXHR
			 */
			find: function(data, callback) {
				var data = $.extend({}, data);
				return _library.get("articles", data, callback);
			},

			/**
			 * Convenience method to find recent articles
			 * 
			 * @param  {object} 	data     	Data to be sent to the server
			 * @param  {integer} 	count	 	Number of articles to retrieve
			 * @return {jqXHR}    				See: http://api.jquery.com/jQuery.ajax/#jqXHR
			 */
			recent: function(count, callback) {
				var data = $.extend({}, { per_page: 5 }, { per_page: count });
				return _library.articles.find(data, callback);
			},

			/**
			 * Find popular articles
			 * 
			 * @param  {object} 	data     	Data to be sent to the server
			 * @param  {function} 	callback 	Function to run when request is successful
			 * @return {jqXHR}    				See: http://api.jquery.com/jQuery.ajax/#jqXHR
			 */
			popular: function(data, callback) {
				var data = $.extend({}, data, { order_by: "score", score: "trending" });
				return _library.get("articles", data, callback);
			},

			/**
			 * Find articles related to a specific article
			 * 
			 * @param  {integer} 	id        	ID of article to lookup other articles against
			 * @param  {object} 	data     	Data to be sent to the server
			 * @param  {function} 	callback 	Function to run when request is successful
			 * @return {deferred}    			See: http://api.jquery.com/category/deferred-object/
			 */
			related: function(id, data, callback) {

				// if the user passed additional related IDs, merge them with ours
				var ids = data && data.excluded_ids ? id + "," + data.excluded_ids : id;

				var data = $.extend({}, data, { excluded_ids: ids });

				var toReturn;
				
				var article = _library.articles.find({id: id});

				var relatedByTags = article.then(function (payload) {
					var tagIds = _library.utility.extractEmbeddedItemIds(payload, "tags");
					var tagData = $.extend({}, data, { tags: tagIds.join(",") });
					return _library.articles.find(tagData);
				});

				var relatedByTopics = article.then(function (payload) {
					var topicIds = _library.utility.extractEmbeddedItemIds(payload, "topics");
					var topicData = $.extend({}, data, { topics: topicIds.join(",") });
					return relatedByTopics = _library.articles.find(topicData);
				});

				relatedByTags.done(function (payload) {
					toReturn = (payload._embedded.articles) ? "tags" : "topics";
				});

				return (toReturn == "tags") ? relatedByTags.done(callback) : relatedByTopics.done(callback);
			}
		},

		/**
	     * Utility methods
	     * @type {Object}
	     */
		utility: {

			/**
			 * Extract the IDs of all items in a given
			 * embedded object; for example tags or topics.
			 * 
			 * @param  {object} payload Payload to extract embedded item IDs from
			 * @param  {string} object  Target object (like "tags")
			 * @return {array}        	IDs
			 */
			extractEmbeddedItemIds: function(payload, object) {
				var target = (payload && payload._embedded && payload._embedded[object]) || [];
				return $.map(target, function (value, i) {
					return value.id
 				});
			}
		}
	}

})(window, jQuery);

/* **********************************************
     Begin hubWidget.js
********************************************** */

var hubWidget = (function ($, hubJS) {

	/**
	 * hubWidget object for reference
	 * inside return object below.
	 * @type {Object}
	 */
	var _library;

	return {

		/**
		 * Holds the various data attributes passed
		 * to the widget
		 * @type {Object}
		 */
		data: {},

		/**
		 * Widget container div
		 * @type {Object}
		 */
		widget: {},

		/**
		 * Default widget title 
		 * @type {String}
		 */
		defaultTitle: "News from the Hub",

		/**
		 * Default number of articles to get
		 * @type {Integer}
		 */
		defaultCount: 5,

		/**
		 * Initialize the hub widget
		 * @return {object} hubWidget
		 */
		init: function() {

			_library = this;

			_library.widget = $("#hubWidget");
			_library.extractDataAttrs();
			_library.widget.html(_library.createInitialHtml());

			// Initialize hubJS
			hubJS.init({ v: 0 });
			hubJS.baseUrl = "http://local.api.hub.jhu.edu/";

			return _library;
		},

		/**
		 * Extracts the data attributes from the widget div
		 * for use in creating the widgets appearance and
		 * creating the data to send to hubJS.
		 * @return null
		 */
		extractDataAttrs: function() {
			_library.data.title = _library.widget.attr("data-title") || _library.defaultTitle;
			_library.data.count = _library.widget.attr("data-count") || _library.defaultCount;
			_library.data.topics = _library.widget.attr("data-topics");
			_library.data.tags = _library.widget.attr("data-tags");
		},

		/**
		 * Creates the HTML that initially populares the widget
		 * @return {string} The HTML
		 */
		createInitialHtml: function() {
			var html = "<div class=\"header\">" + _library.data.title + "</div>";
			html += "<div class=\"content loading\"></div>";
			html += "<div class=\"hubpower clearfix\"><div class=\"link\"><a href=\"http://hub.jhu.edu\">http://hub.jhu.edu</a></div><div class=\"image\"><a href=\"http://hub.jhu.edu\"><span>Powered by the Hub</span></a></div></div>";
			return html;
		},

		/**
		 * Get articles to populate the widget
		 * @param  {Lamdba(data, jqXHR)} Callback that fires upon successful retrieval of data.
		 * @return {object} hubWidget
		 */
		getArticles: function() {

			var data = _library.utility.compileData();

			hubJS.articles.find(data, function(payload) {
				if (!payload.error) {
					_library.populateWidget(payload._embedded.articles);
				} else {
					_library.displayError();
				}
			});
			return _library;
		},

		/**
		 * Populare the widget with found articles
		 * @param  {array} articles Array of article objects
		 * @return {object} hubWidget
		 */
		populateWidget: function(articles) {
			_library.widget.find(".content").removeClass("loading");
			_library.widget.find(".content").html($("<ul>"));

			$.each(articles, function(i, article) {
				var html = "<li><p class=\"headline\"><a href=\"" + article.url +"\">" + article.headline +"</a></p>";
                var html = html + "<p class=\"pubdate\">" + _library.utility.getPublishDate(article.publish_date) + "</a></p></li>";
				_library.widget.find("ul").append(html);
			});
		},

		/**
		 * Set of utiltiy functions
		 * @type {Object}
		 */
		utility: {
			getPublishDate: function(timestamp) {
				var date = new Date(timestamp * 1000);
				var month = _library.utility.getMonth(date);
				var day = date.getDate();
				var year = date.getFullYear();

				return fullDate = month + " " + day + ", " + year;
			},
			getMonth: function(dateObject) {
				var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
				return monthNames[dateObject.getMonth()];
			},
			compileData: function() {
				var data = {};
				data.per_page = $.isNumeric(_library.data.count) ? _library.data.count : _library.defaultCount;

				if (_library.data.topics) {
					data.topics = _library.utility.cleanList(_library.data.topics);
				}

				if (_library.data.tags) {
					data.tags = _library.utility.cleanList(_library.data.tags);
				}

				return data;
			},
			cleanList: function (string) {
				return string.replace(/\s/g, "");
			}
		},
		displayError: function() {
			_library.widget.find(".content").html("<p>Sorry, no results were found. Trying checking out <a href=\"http://hub.jhu.edu\">The Hub</a> for the latest Johns Hopkins news.</p>");
		}
	}
})(jQuery, hubJS);

jQuery(document).ready(function ($) {
    hubWidget.init().getArticles();
});